<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NICE Copilot 365 KPIs</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f1a2e;--text:#e6edf7;--muted:#a9b7d0;--border:rgba(255,255,255,.12);--chip:rgba(122,162,255,.12);--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      background:radial-gradient(1200px 800px at 20% 0%,rgba(122,162,255,.18),transparent 55%),
                 radial-gradient(1000px 700px at 100% 20%,rgba(56,189,248,.12),transparent 60%),
                 var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);background:rgba(11,18,32,.75);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:rgba(15,26,46,.55);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-size:13px}
    .tab.active{border-color:rgba(122,162,255,.7);background:rgba(122,162,255,.18)}
    .controls{display:flex;gap:10px;flex:1;justify-content:flex-end;flex-wrap:wrap;align-items:center}
    .search{flex:1;min-width:220px;max-width:420px;display:flex;align-items:center;gap:8px;background:rgba(15,26,46,.55);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:13px}
    .select{
      min-width:220px;
      background:rgba(15,26,46,.55);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }
    .btn{border:1px solid var(--border);background:rgba(15,26,46,.55);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-size:13px;box-shadow:var(--shadow)}
    .btn:hover{border-color:rgba(56,189,248,.7)}
    main{padding:18px}
    .panel{max-width:1200px;margin:0 auto;background:rgba(15,26,46,.55);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .meta{display:flex;gap:10px;flex-wrap:wrap;padding:14px 14px 0 14px;color:var(--muted);font-size:12px}
    .chip{background:var(--chip);border:1px solid rgba(122,162,255,.25);padding:6px 10px;border-radius:999px}
    .table-wrap{overflow:auto;max-height:calc(100vh - 230px)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);border-bottom:1px solid var(--border);text-align:left;padding:10px 12px;font-size:12px;color:#d9e6ff;cursor:pointer;user-select:none;white-space:nowrap}
    tbody td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 12px;font-size:12.5px;color:var(--text);vertical-align:top}
    tbody tr:hover td{background:rgba(122,162,255,.06)}
    .footer{max-width:1200px;margin:10px auto 24px auto;padding:0 18px;color:var(--muted);font-size:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border:1px solid var(--border);background:rgba(0,0,0,.2);border-radius:8px;padding:2px 6px;margin:0 2px}
    @media (max-width:650px){table{min-width:700px}.controls{justify-content:flex-start}}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>NICE Copilot 365 KPI Workbook</h1>
    <div class="sub">Interactive view of <span class="muted">Nice CP365 KPIS.xlsx</span>. Static HTML + JSON (GitHub Pages friendly).</div>
    <div class="row">
      <div class="tabs" id="tabs"></div>
      <div class="controls">
        <select class="select" id="dept" title="Filter by Department">
          <option value="">All Departments</option>
        </select>

        <div class="search" title="Search within the active sheet">
          <span aria-hidden="true">üîé</span>
          <input id="q" placeholder="Search‚Ä¶ (matches any column)" />
        </div>

        <button class="btn" id="download">‚¨áÔ∏è Download CSV</button>
        <button class="btn" id="clear">‚úñ Clear</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="meta" id="meta"></div>
    <div class="table-wrap">
      <table aria-label="Workbook table">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<div class="footer">Tips: click a column header to sort; <span class="kbd">Ctrl</span>+<span class="kbd">F</span> for browser find. This is client-side only.</div>

<script>
  let DATA = null;

  const state = {
    sheet: null,
    q: '',
    dept: '',
    sort: { col: null, dir: 'asc' }
  };

  const elTabs = document.getElementById('tabs');
  const elQ = document.getElementById('q');
  const elDept = document.getElementById('dept');
  const elHead = document.getElementById('thead');
  const elBody = document.getElementById('tbody');
  const elMeta = document.getElementById('meta');
  const elDownload = document.getElementById('download');
  const elClear = document.getElementById('clear');

  function normalize(s){ return String(s ?? '').toLowerCase(); }

  function makeTabs(){
    elTabs.innerHTML='';
    Object.keys(DATA).forEach(name=>{
      const b=document.createElement('button');
      b.className='tab' + (name===state.sheet?' active':'');
      b.textContent=name;
      b.onclick=()=>{
        state.sheet=name;
        state.sort={col:null,dir:'asc'};
        state.q='';
        state.dept='';
        elQ.value='';
        rebuildDepartmentDropdown();
        render();
      };
      elTabs.appendChild(b);
    });
  }

  function rebuildDepartmentDropdown(){
    // Reset dropdown
    elDept.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All Departments';
    elDept.appendChild(optAll);

    const sheet = DATA[state.sheet];
    const cols = sheet.columns || [];
    const deptIdx = cols.findIndex(c => normalize(c) === 'department');

    // If no Department column exists, disable dropdown gracefully
    if (deptIdx === -1){
      elDept.disabled = true;
      elDept.title = 'No Department column found in this sheet';
      return;
    }

    elDept.disabled = false;
    elDept.title = 'Filter by Department';

    // Unique department values (non-empty)
    const set = new Set();
    (sheet.rows || []).forEach(r=>{
      const v = String(r[deptIdx] ?? '').trim();
      if (v) set.add(v);
    });

    Array.from(set).sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      elDept.appendChild(o);
    });

    // Restore selection (if any)
    elDept.value = state.dept || '';
  }

  function getFilteredRows(){
    const sheet = DATA[state.sheet];
    const cols = sheet.columns;
    const rows = sheet.rows;

    const q = normalize(state.q).trim();

    const deptIdx = cols.findIndex(c => normalize(c) === 'department');
    const deptFilter = String(state.dept ?? '').trim();

    let out = rows;

    // Department filter
    if (deptFilter && deptIdx !== -1){
      out = out.filter(r => String(r[deptIdx] ?? '').trim() === deptFilter);
    }

    // Search filter (any column)
    if (q){
      out = out.filter(r => r.some(cell => normalize(cell).includes(q)));
    }

    // Sorting
    if (state.sort.col !== null){
      const idx=state.sort.col;
      const dir = state.sort.dir==='asc'?1:-1;

      out=[...out].sort((a,b)=>{
        const va=a[idx], vb=b[idx];
        const na=Number(String(va).replace(/,/g,''));
        const nb=Number(String(vb).replace(/,/g,''));
        const both=!Number.isNaN(na)&&!Number.isNaN(nb)&&String(va).trim()!==''&&String(vb).trim()!=='';
        if(both) return (na-nb)*dir;
        return String(va).localeCompare(String(vb))*dir;
      });
    }

    return out;
  }

  function render(){
    makeTabs();

    const sheet = DATA[state.sheet];
    const cols = sheet.columns;
    const rows = getFilteredRows();

    // Meta chips
    elMeta.innerHTML='';
    const chip = (t)=>{ const d=document.createElement('div'); d.className='chip'; d.textContent=t; return d; };
    elMeta.append(
      chip('Sheet: '+state.sheet),
      chip('Columns: '+cols.length),
      chip('Rows: '+rows.length),
      chip(state.dept ? ('Department: '+state.dept) : 'Department: (all)'),
      chip(state.q ? ('Search: ‚Äú'+state.q+'‚Äù') : 'Search: (none)')
    );

    // Header
    elHead.innerHTML='';
    cols.forEach((c,idx)=>{
      const th=document.createElement('th');
      const active=state.sort.col===idx;
      const arrow=active?(state.sort.dir==='asc'?' ‚ñ≤':' ‚ñº'):'';
      th.textContent=c+arrow;
      th.onclick=()=>{
        if(state.sort.col===idx){ state.sort.dir=state.sort.dir==='asc'?'desc':'asc'; }
        else { state.sort.col=idx; state.sort.dir='asc'; }
        render();
      };
      elHead.appendChild(th);
    });

    // Body
    elBody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      r.forEach(cell=>{
        const td=document.createElement('td');
        td.textContent=String(cell);
        tr.appendChild(td);
      });
      elBody.appendChild(tr);
    });
  }

  // Events
  elQ.addEventListener('input', e=>{ state.q=e.target.value; render(); });
  elDept.addEventListener('change', e=>{ state.dept=e.target.value; render(); });

  elClear.onclick=()=>{
    elQ.value='';
    state.q='';
    state.dept='';
    elDept.value='';
    state.sort={col:null,dir:'asc'};
    render();
  };

  function downloadCSV(){
    const columns = DATA[state.sheet].columns;
    const filtered = getFilteredRows();
    const esc=(v)=>{ const s=String(v??''); return /[\n\r,\"]/g.test(s) ? '\"'+s.replace(/\"/g,'\"\"')+'\"' : s; };
    const csv=[columns.map(esc).join(','), ...filtered.map(r=>r.map(esc).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=state.sheet.replace(/\s+/g,'_')+'.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  elDownload.onclick=downloadCSV;

  // Load JSON
  fetch('./data.json')
    .then(r=>r.json())
    .then(j=>{
      DATA=j;
      state.sheet=Object.keys(DATA)[0];
      rebuildDepartmentDropdown();
      render();
    })
    .catch(err=>{
      document.body.innerHTML=
        '<div style="padding:24px;color:#fff;font-family:system-ui">' +
        'Failed to load data.json. Make sure index.html and data.json are in the same folder.' +
        '<br><pre>'+String(err)+'</pre></div>';
    });
</script>
</body>
</html>
``
